name: Build Windows

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - development

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Download SDL 1.2 Devel
      run: |
        Invoke-WebRequest -Uri "https://www.libsdl.org/release/SDL-devel-1.2.15-VC.zip" -OutFile "SDL-devel-1.2.15-VC.zip"
        Expand-Archive -Path "SDL-devel-1.2.15-VC.zip" -DestinationPath "C:\SDL"
        
    - name: Download SDL_mixer 1.2 Devel
      run: |
        Invoke-WebRequest -Uri "https://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-devel-1.2.12-VC.zip" -OutFile "SDL_mixer-devel-1.2.12-VC.zip"
        Expand-Archive -Path "SDL_mixer-devel-1.2.12-VC.zip" -DestinationPath "C:\SDL"

    - name: Build ImageLib
      run: |
        msbuild ImageLib/src/VC2022/ImageLib.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143

    - name: Build BlockOut
      run: |
        $ImageLibSrc = Resolve-Path "ImageLib/src"
        $ImageLibLib = Resolve-Path "ImageLib/src/VC2022/x64/Release"
        msbuild BlockOut/VC2022/Blockout.vcxproj /p:Configuration=Release /p:Platform=x64 /p:PlatformToolset=v143

    - name: Download SDL Runtime Binaries
      run: |
        Invoke-WebRequest -Uri "https://www.libsdl.org/release/SDL-1.2.15-win32-x64.zip" -OutFile "SDL-1.2.15-win32-x64.zip"
        Expand-Archive -Path "SDL-1.2.15-win32-x64.zip" -DestinationPath "dist_sdl"
        
        # SDL_mixer 1.2.12 x64 binary might be tricky to find officially or might be in the devel package?
        # The devel package lib/x64 usually only has the .lib.
        # Let's try to get the x64 runtime if available, otherwise we might miss DLLs.
        # Official site lists SDL_mixer-1.2.12-win32.zip (32-bit). x64 was not standard then.
        # However, the devel package has x64 libs, so maybe there is a binary?
        # If not, we might only get the exe and SDL.dll.
        # Let's assume for now we just copy what we can.
        
    - name: Prepare Artifacts
      run: |
        New-Item -ItemType Directory -Force -Path dist
        Copy-Item BlockOut/VC2022/x64/Release/Blockout.exe -Destination dist/
        Copy-Item BlockOut/images -Destination dist/images -Recurse
        Copy-Item BlockOut/sounds -Destination dist/sounds -Recurse
        Copy-Item dist_sdl/SDL.dll -Destination dist/
        
        # Try to find SDL_mixer.dll in the devel package if it exists, or skip it
        # C:\SDL\SDL_mixer-1.2.12\lib\x64 might have it?
        if (Test-Path "C:\SDL\SDL_mixer-1.2.12\lib\x64\SDL_mixer.dll") {
          Copy-Item "C:\SDL\SDL_mixer-1.2.12\lib\x64\SDL_mixer.dll" -Destination dist/
        }

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: blockout-windows
        path: dist/

    - name: Create Windows ZIP package
      run: |
        $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
        $RELEASE_DATE = (Get-Date).ToUniversalTime().ToString("yyyyMMdd")
        $VERSION = "2.5-${{ github.ref_name }}-$RELEASE_DATE-$SHORT_SHA"
        $ZIP_NAME = "blockout-windows-$VERSION.zip"
        Compress-Archive -Path dist/* -DestinationPath $ZIP_NAME
        echo "ZIP_NAME=$ZIP_NAME" >> $env:GITHUB_ENV

    - name: Calculate Release Tag
      id: tag
      run: |
        $SHORT_SHA = "${{ github.sha }}".Substring(0, 7)
        $RELEASE_DATE = (Get-Date).ToUniversalTime().ToString("yyyyMMdd")
        $VERSION = "2.5-${{ github.ref_name }}-$RELEASE_DATE-$SHORT_SHA"
        echo "RELEASE_TAG=blockout-$VERSION" >> $env:GITHUB_ENV

    - name: Upload to Release
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development')
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        files: ${{ env.ZIP_NAME }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
