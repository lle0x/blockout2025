name: Build macOS (brew)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - development
    paths:
      - ".github/workflows/build-macos-brew.yml"
      - "BlockOut/**"
      - "ImageLib/**"
      - "build-and-run.sh"
      - "install-ubuntu-deps.sh"

permissions:
  contents: write

jobs:
  macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (Homebrew)
        run: |
          brew update
          brew install sdl12-compat pkg-config gettext

      - name: Build SDL_mixer 1.2 from source
        run: |
          cd /tmp
          curl -L https://www.libsdl.org/projects/SDL_mixer/release/SDL_mixer-1.2.12.tar.gz -o SDL_mixer-1.2.12.tar.gz
          tar xzf SDL_mixer-1.2.12.tar.gz
          cd SDL_mixer-1.2.12
          ./configure --prefix=/opt/homebrew
          make
          sudo make install

      - name: Set build env
        id: brew-env
        run: |
          PREFIX=$(brew --prefix)
          GETTEXT_PREFIX=$(brew --prefix gettext)
          echo "HOMEBREW_PREFIX=$PREFIX" >> $GITHUB_ENV
          echo "CXXFLAGS=-I${PREFIX}/include -I${GETTEXT_PREFIX}/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L${PREFIX}/lib -L${GETTEXT_PREFIX}/lib -lintl" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=${PREFIX}/lib/pkgconfig" >> $GITHUB_ENV

      - name: Build ImageLib and BlockOut (release)
        run: |
          make -C ImageLib/src
          make -C BlockOut _macos=1 EXTRA_CXXFLAGS="$CXXFLAGS" EXTRA_LDFLAGS="$LDFLAGS"

      - name: Package app bundle
        run: |
          VERSION_BASE="2.5"
          RELEASE_DATE=$(date -u +%Y%m%d)
          PKG_NAME="blockout-${VERSION_BASE}-${GITHUB_REF_NAME}-${RELEASE_DATE}-${GITHUB_RUN_NUMBER}-macos"
          mkdir -p "dist/${PKG_NAME}/BlockOut.app/Contents/MacOS"
          mkdir -p "dist/${PKG_NAME}/BlockOut.app/Contents/Resources"
          cp BlockOut/blockout "dist/${PKG_NAME}/BlockOut.app/Contents/MacOS/"
          cp -r BlockOut/images BlockOut/sounds "dist/${PKG_NAME}/BlockOut.app/Contents/Resources/"
          cp README.md "dist/${PKG_NAME}/"
          cp BlockOut/README.txt "dist/${PKG_NAME}/README.BlockOut.txt"
          tar -czf "dist/${PKG_NAME}.tar.gz" -C dist "${PKG_NAME}"
          echo "MAC_PKG=dist/${PKG_NAME}.tar.gz" >> $GITHUB_ENV

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: blockout-macos-${{ github.ref_name }}
          path: ${{ env.MAC_PKG }}

      - name: Calculate Release Tag
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          RELEASE_DATE=$(date -u +%Y%m%d)
          echo "RELEASE_TAG=blockout-2.5-${{ github.ref_name }}-${RELEASE_DATE}-${SHORT_SHA}" >> $GITHUB_ENV

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development')
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ${{ env.MAC_PKG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
